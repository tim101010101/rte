<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      .loading {
        width: 150px;
        height: 4px;
        border-radius: 2px;
        margin: 0 auto;
        margin-top: 10px;
        margin-bottom: 10px;
        position: relative;
        background: lightgreen;
        -webkit-animation: changeBgColor 1.04s ease-in infinite alternate;
      }
      .loading span {
        display: inline-block;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: lightgreen;
        position: absolute;
        margin-top: -7px;
        margin-left: -8px;
        -webkit-animation: changePosition 1.04s ease-in infinite alternate;
      }
      @-webkit-keyframes changeBgColor {
        0% {
          background: lightgreen;
        }
        100% {
          background: lightblue;
        }
      }

      @-webkit-keyframes changePosition {
        0% {
          background: lightgreen;
        }
        100% {
          margin-left: 142px;
          background: lightblue;
        }
      }
    </style>
  </head>
  <body>
    <div>
      <div class="loading">
        <span></span>
      </div>

      <div>
        <button id="startButton">start(requestIdleCallback)</button>
      </div>
      <div>
        <button id="startButtonSync">start(sync)</button>
      </div>

      <div id="log"></div>
    </div>

    <script>
      let logFragment = null;
      const log = text => {
        if (!logFragment) {
          logFragment = document.createDocumentFragment();
        }

        const el = document.createElement('div');
        el.innerHTML = text;
        logFragment.appendChild(el);
      };

      const getRandomIntInclusive = (min, max) => {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min + 1)) + min;
      };

      let taskHandle = null;
      let statusRefreshScheduled = false;
      const taskList = [
        () => log('task1'),
        () => log('task2'),
        () => log('task3'),
        () => log('task4'),
      ];

      // 绘制内容
      const logEle = document.getElementById('log');
      const updateDisplay = time => {
        if (logFragment) {
          logEle.appendChild(logFragment);
          logFragment = null;
        }
        statusRefreshScheduled = false;
      };

      // 规划 DOM 改变
      const scheduleStatusRefresh = () => {
        if (!statusRefreshScheduled) {
          requestAnimationFrame(updateDisplay);
          statusRefreshScheduled = true;
        }
      };

      const runTaskQueue = ddl => {
        while ((ddl.timeRemaining() > 0 || ddl.didTimeout) && taskList.length) {
          taskList.shift()();
          scheduleStatusRefresh();
        }

        if (taskList.length) {
          taskHandle = requestIdleCallback(runTaskQueue, { timeout: 1000 });
        } else {
          taskHandle = 0;
        }
      };

      const enqueueTask = fn => {
        taskList.push(fn);

        if (!taskHandle) {
          taskHandle = requestIdleCallback(runTaskQueue, { timeout: 1000 });
        }
      };

      const addTask = () => {
        const len = getRandomIntInclusive(50000, 100000);
        Array.from({ length: len }).forEach((_, i) => {
          enqueueTask(() => log(`task num ${i + 1} of list ${len}`));
        });
      };

      const addTaskSync = () => {
        const len = getRandomIntInclusive(50000, 100000);
        Array.from({ length: len }).forEach((_, i) => {
          log(`task num ${i + 1} of list ${len}`);
        });
        scheduleStatusRefresh();
      };

      document
        .querySelector('#startButton')
        .addEventListener('click', addTask, false);

      document
        .querySelector('#startButtonSync')
        .addEventListener('click', addTaskSync, false);
    </script>
  </body>
</html>
